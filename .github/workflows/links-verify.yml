name: Verify Site Links

on:
  push: {} #  uncommnet for testing
  schedule: # daily at 12 noon UTC
    - cron: '0 12 * * *'

jobs:
  build:
    runs-on: ubuntu-18.04
    steps:
    - name: content checkout
      uses: actions/checkout@v2.4.0  # https://github.com/marketplace/actions/checkout
      with:
        repository: demisto/content
        path: content
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        ref: 'master'
    - name: content-docs checkout
      uses: actions/checkout@v2.4.0  # https://github.com/marketplace/actions/checkout
      with:
        repository: demisto/content-docs
        path: content-docs
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        ref: 'Fix_broken_links'
    - name: create ignore url files
      run: |
        ls
        find content/Packs/* -name 'README.md' | xargs sed -n '/^## Commands/,/^## /p' | grep -EIoi '(http|https)://[a-zA-Z0-9./?=_%:-]*' | sort -u > out.txt
        sed -i -e 's/^/-e "/' out.txt
        sed -i -e 's/$/"/' out.txt
        cat content-docs/urls_ignore.txt >> out.txt
        sort -u out.txt
        cat out.txt
    - name: Set up Go 1.13
      uses: actions/setup-go@v2
      with:
        go-version: 1.13.11
      id: go
    - name: Setup muffet
      run: 'go get -u github.com/raviqqe/muffet'
    - name: Verify Links
      run: |
        muffet --version
        $(< out.txt)
        muffet -c 16 --ignore-fragments -b 8192 \
        https://xsoar.pan.dev > muffet.txt 2>&1 && echo "muffet completed successfully" && exit 0 || echo "muffet failed but still need to verify output file..."
        grep -v -E '^\s+(401|403|405|429|x509|lookup|parse|timeout|dial)' muffet.txt > muffet-clean.out
        echo "Muffet output after 401, 403, 405, 429 and x509 remove:"
        cat muffet-clean.out
        if [ -n "$(grep -v '^https'  muffet-clean.out)" ]; then
          echo "muffet failed verification!!!"
          exit 1
        fi
        echo "All good! muffet passed!!!"
    - name: Save artifcats
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: log-artifacts
        path: muffet.txt
