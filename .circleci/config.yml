### =============================================================
### This configuration file is used by CircleCI build server
### https://circleci.com/docs/config-sample
### =============================================================
version: 2.1
jobs:
  build:

      machine:
        image: ubuntu-1604:202007-01

      steps:
        - checkout
        - run:
            name: Setup Node
            command: |
              echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV
              source $BASH_ENV
              nvm install `cat .nvmrc`              
        - run:
            name: Setup Python
            command: |
              pyenv versions
              pyenv global 3.7.8 3.8.3
              pip3 install pipenv 
        - run:
            name: NPM Build
            command: |
              nvm use
              node --version
              npm --version
              npm ci
              npm run build
              echo "Build is done. Create tar of the build dir"
              tar czvf build-site.tar.gz build
        - store_artifacts:
            path: build-site.tar.gz             

        - run:
            name: Deploy to Netlify
            command: |
              npm install -g netlify-cli
              netlify --version
              netlify deploy -m "CircleCI build: $CIRCLE_BRANCH" -d build --alias="$CIRCLE_BRANCH" --json


workflows:
  build_and_release:
    jobs:
      - build
